<!DOCTYPE html> 
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Nutrition Map</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
<style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #F5F0F5;
      margin: 60px 60px;
    }
    h1 {
      margin-bottom: 40px;
    }
    #controls {
      margin-bottom: 25px;
    }
    .filter-btn {
      padding: 12px 25px;
      font-size: 16px;
      margin: 0 5px;
      cursor: pointer;
      border: none;
      outline: none;
      border-radius: 5px;
      background: #fff;
      font-weight: 600;
    }
    .filter-btn.active {
      background: #4CAF50;
      color: white;
    }
    svg {
      display: block;
      margin: 0 auto;
      background: #F5F0F5; /* —Ñ–æ–Ω svg */
    }
    .tooltip {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      padding: 6px 10px;
      font-size: 14px;
      pointer-events: none;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      opacity: 0;
      transition: opacity 0.2s;
      max-width: 200px;
      text-align: left;
    }
    #legend div {
      margin: 2px 0;
      padding: 0;
      line-height: 1.5;
    }
    #legend {
      max-width: 400px;
      margin: 20px auto 0;
      text-align: center;
      font-size: 16px;
      line-height: 1.3;
      color: #555;
    }
    #legend .macros {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 10px;
    }
    #legend span.color-box {
      display: inline-block;
      width: 16px;
      height: 16px;
      vertical-align: middle;
      border-radius: 4px;
    }
  </style>
</head>
<body>

<h1>Nutrition Map</h1>

<div id="controls">
  <button class="filter-btn active" data-category="all">–í—Å–µ</button>
  <button class="filter-btn" data-category="fruit">–§—Ä—É–∫—Ç—ã</button>
  <button class="filter-btn" data-category="vegetable">–û–≤–æ—â–∏</button>
</div>

<svg width="1400" height="800"></svg>

<div id="legend">
  <div class="macros">
    <div><span class="color-box" style="background:red;"></span> –ñ–∏—Ä—ã</div>
    <div><span class="color-box" style="background:green;"></span> –£–≥–ª–µ–≤–æ–¥—ã</div>
    <div><span class="color-box" style="background:blue;"></span> –ë–µ–ª–∫–∏</div>
  </div>
  <div><strong>–†–∞–∑–º–µ—Ä –∫—Ä—É–≥–∞:</strong> –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å</div>
  <div><strong>–û—Å—å X:</strong> —Å–∞—Ö–∞—Ä (–≥)</div>
  <div><strong>–û—Å—å Y:</strong> –∫–ª–µ—Ç—á–∞—Ç–∫–∞ (–≥)</div>
</div>

<div class="tooltip"></div>

<script>
const data = [
  { name: "–Ø–±–ª–æ–∫–æ", kcal: 52, b: 0.26, j: 0.17, u: 13.81, fiber: 2.4, sugar: 10.4, category: "fruit" },
  { name: "–ë–∞–Ω–∞–Ω", kcal: 89, b: 1.09, j: 0.33, u: 22.84, fiber: 2.6, sugar: 12.2, category: "fruit" },
  { name: "–ú–æ—Ä–∫–æ–≤—å", kcal: 41, b: 0.93, j: 0.24, u: 9.58, fiber: 2.8, sugar: 4.7, category: "vegetable" },
  { name: "–ê–≤–æ–∫–∞–¥–æ", kcal: 160, b: 2, j: 14.66, u: 8.53, fiber: 6.7, sugar: 0.7, category: "fruit" },
  { name: "–ö–∏–≤–∏", kcal: 61, b: 1.14, j: 0.52, u: 14.66, fiber: 3, sugar: 9, category: "fruit" },
  { name: "–ì—Ä—É—à–∞", kcal: 57, b: 0.36, j: 0.14, u: 15.23, fiber: 3.1, sugar: 9.8, category: "fruit" },
  { name: "–û–≥—É—Ä–µ—Ü", kcal: 15, b: 0.65, j: 0.11, u: 3.63, fiber: 0.5, sugar: 1.7, category: "vegetable" },
  { name: "–¢–æ–º–∞—Ç", kcal: 18, b: 0.88, j: 0.2, u: 3.89, fiber: 1.2, sugar: 2.6, category: "fruit" },
  { name: "–°–≤—ë–∫–ª–∞", kcal: 43, b: 1.61, j: 0.17, u: 9.56, fiber: 2.8, sugar: 6.8, category: "vegetable" },
  { name: "–ë—Ä–æ–∫–∫–æ–ª–∏", kcal: 34, b: 2.82, j: 0.37, u: 6.64, fiber: 2.6, sugar: 1.7, category: "vegetable" },
  { name: "–ö–∞–ø—É—Å—Ç–∞", kcal: 25, b: 1.28, j: 0.1, u: 5.8, fiber: 2.5, sugar: 3.2, category: "vegetable" },
  { name: "–ê–±—Ä–∏–∫–æ—Å", kcal: 48, b: 1.4, j: 0.39, u: 11.12, fiber: 2, sugar: 9.2, category: "fruit" },
  { name: "–ê–ø–µ–ª—å—Å–∏–Ω", kcal: 47, b: 0.94, j: 0.12, u: 11.75, fiber: 2.4, sugar: 9.4, category: "fruit" },
  { name: "–ì—Ä–µ–π–ø—Ñ—Ä—É—Ç", kcal: 42, b: 0.77, j: 0.14, u: 10.66, fiber: 1.6, sugar: 6.9, category: "fruit" },
  { name: "–í–∏–Ω–æ–≥—Ä–∞–¥", kcal: 69, b: 0.72, j: 0.16, u: 18.1, fiber: 0.9, sugar: 15.5, category: "fruit" },
  { name: "–ê–Ω–∞–Ω–∞—Å", kcal: 50, b: 0.54, j: 0.12, u: 13.12, fiber: 1.4, sugar: 9.9, category: "fruit" },
  { name: "–ì–æ–ª—É–±–∏–∫–∞", kcal: 57, b: 0.74, j: 0.33, u: 14.49, fiber: 2.4, sugar: 10, category: "fruit" },
  { name: "–ú–∞–ª–∏–Ω–∞", kcal: 52, b: 1.2, j: 0.65, u: 11.94, fiber: 6.5, sugar: 4.4, category: "fruit" },
  { name: "–®–ø–∏–Ω–∞—Ç", kcal: 23, b: 2.86, j: 0.39, u: 3.63, fiber: 2.2, sugar: 0.4, category: "vegetable" },
  { name: "–ü–µ—Ä–µ—Ü", kcal: 31, b: 0.99, j: 0.3, u: 6.03, fiber: 2.1, sugar: 4.2, category: "vegetable" },
  { name: "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å", kcal: 77, b: 2.05, j: 0.09, u: 17.49, fiber: 2.1, sugar: 0.8, category: "vegetable" },
  { name: "–ö—É–∫—É—Ä—É–∑–∞", kcal: 86, b: 3.27, j: 1.35, u: 18.7, fiber: 2, sugar: 6.3, category: "vegetable" },
  { name: "–ö–∞–±–∞—á–æ–∫", kcal: 15, b: 1.14, j: 0.36, u: 2.69, fiber: 1, sugar: 1.7, category: "vegetable" },
  { name: "–¢—ã–∫–≤–∞", kcal: 26, b: 1, j: 0.1, u: 6.5, fiber: 0.5, sugar: 2.8, category: "vegetable" },
  { name: "–û–ª–∏–≤–∫–∞", kcal: 145, b: 1.03, j: 15.32, u: 3.84, fiber: 3.3, sugar: 0.5, category: "fruit" }
];

const svg = d3.select("svg");
const width = +svg.attr("width");
const height = +svg.attr("height");
const margin = { top: 70, right: 10, bottom: 60, left: 10 };
const plotWidth = width - margin.left - margin.right;
const plotHeight = height - margin.top - margin.bottom;

const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

const xScale = d3.scaleLinear()
  .domain([0, Math.ceil(d3.max(data, d => d.sugar))])
  .range([0, plotWidth]);

const yScale = d3.scaleLinear()
  .domain([0, Math.ceil(d3.max(data, d => d.fiber))])
  .range([plotHeight, 0]);

// –ù–æ–≤–∞—è —à–∫–∞–ª–∞ —Ä–∞–¥–∏—É—Å–æ–≤ —á–µ—Ä–µ–∑ –ø–ª–æ—â–∞–¥—å
const areaScale = d3.scalePow()
  .exponent(1.5) // –º–µ–Ω—å—à–µ 1 ‚Äî —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É –º–∞–ª–µ–Ω—å–∫–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
  .domain([16, 160])
  .range([Math.PI * 10**2, Math.PI * 22**2]);
const manualAdjustments = {
  // ü•¶ –û–≤–æ—â–∏
"–û–≥—É—Ä–µ—Ü": 0.9,
"–®–ø–∏–Ω–∞—Ç": 1.1,
"–ö–∞–ø—É—Å—Ç–∞":1.1,
"–¢—ã–∫–≤–∞": 1.2,
"–ü–µ—Ä–µ—Ü": 1.2,
"–ë—Ä–æ–∫–∫–æ–ª–∏": 1.25,
"–ú–æ—Ä–∫–æ–≤—å": 1.3,
"–ì—Ä–µ–π–ø—Ñ—Ä—É—Ç": 1.35,
"–°–≤—ë–∫–ª–∞": 1.25,
"–ê–ø–µ–ª—å—Å–∏–Ω": 1.4,
"–ê–±—Ä–∏–∫–æ—Å": 1.45,
"–ê–Ω–∞–Ω–∞—Å": 1.45,
"–ú–∞–ª–∏–Ω–∞": 1.4,
"–Ø–±–ª–æ–∫–æ": 1.45,
"–ì—Ä—É—à–∞": 1.65,
"–ì–æ–ª—É–±–∏–∫–∞": 1.5,
"–ö–∏–≤–∏": 1.6,
"–í–∏–Ω–æ–≥—Ä–∞–¥": 1.45,
"–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å": 1.8,
"–ö—É–∫—É—Ä—É–∑–∞": 1.9,
"–ë–∞–Ω–∞–Ω": 2.35,
"–û–ª–∏–≤–∫–∞": 2.3,
"–ê–≤–æ–∫–∞–¥–æ": 2.4
};
function radius(d) {
  const base = Math.sqrt(areaScale(d.kcal) / Math.PI);
  const adj = manualAdjustments[d.name] || 1;
  return base * adj;
}



const maxB = d3.max(data, d => d.b);
const maxJ = d3.max(data, d => d.j);
const maxU = d3.max(data, d => d.u);

function getColor(d) {
  const r = 255 * (d.j / maxJ);
  const g = 255 * (d.u / maxU);
  const b = 255 * (d.b / maxB);
  return `rgb(${r},${g},${b})`;
}

const tooltip = d3.select(".tooltip");

const svgMap = {
  "–Ø–±–ª–æ–∫–æ": "Nutrition/Fruits/apple.svg",
  "–ë–∞–Ω–∞–Ω": "Nutrition/Fruits/banana_1.svg",
  "–ê–≤–æ–∫–∞–¥–æ": "Nutrition/Fruits/avocado.svg",
  "–ö–∏–≤–∏": "Nutrition/Fruits/kiwi.svg",
  "–ì—Ä—É—à–∞": "Nutrition/Fruits/pear_1.svg",
  "–ê–±—Ä–∏–∫–æ—Å": "Nutrition/Fruits/apricot.svg",
  "–ê–ø–µ–ª—å—Å–∏–Ω": "Nutrition/Fruits/orange_1.svg",
  "–ì—Ä–µ–π–ø—Ñ—Ä—É—Ç": "Nutrition/Fruits/grapefruit_2.svg",
  "–í–∏–Ω–æ–≥—Ä–∞–¥": "Nutrition/Fruits/grape.svg",
  "–ê–Ω–∞–Ω–∞—Å": "Nutrition/Fruits/pineapple_1.svg",
  "–ì–æ–ª—É–±–∏–∫–∞": "Nutrition/Fruits/blueberry.svg",
  "–ú–∞–ª–∏–Ω–∞": "Nutrition/Fruits/raspberry_1.svg",
  "–û–ª–∏–≤–∫–∞": "Nutrition/Fruits/olive.svg",
  "–ú–æ—Ä–∫–æ–≤—å": "Nutrition/Vegetables/carrot.svg",
  "–û–≥—É—Ä–µ—Ü": "Nutrition/Vegetables/cucumber_2.svg",
  "–¢–æ–º–∞—Ç": "Nutrition/Vegetables/tomato_1.svg",
  "–°–≤—ë–∫–ª–∞": "Nutrition/Vegetables/beet.svg",
  "–ë—Ä–æ–∫–∫–æ–ª–∏": "Nutrition/Vegetables/broccoli_2.svg",
  "–ö–∞–ø—É—Å—Ç–∞": "Nutrition/Vegetables/cabbage_1.svg",
  "–®–ø–∏–Ω–∞—Ç": "Nutrition/Vegetables/spinach.svg",
  "–ü–µ—Ä–µ—Ü": "Nutrition/Vegetables/bell_pepper.svg",
  "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å": "Nutrition/Vegetables/potato.svg",
  "–ö—É–∫—É—Ä—É–∑–∞": "Nutrition/Vegetables/corn.svg",
  "–ö–∞–±–∞—á–æ–∫": "Nutrition/Vegetables/zucchini.svg",
  "–¢—ã–∫–≤–∞": "Nutrition/Vegetables/pumpkin.svg"
};
// –ö—ç—à –¥–ª—è SVG-–∫–æ–Ω—Ç—É—Ä–æ–≤
const svgCache = {};

// –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —Ñ–∏–≥—É—Ä –∏–∑ SVG —Å —É—á—ë—Ç–æ–º viewBox
async function loadSVGShapes(url) {
  if (svgCache[url]) return svgCache[url];
  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const text = await response.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(text, "image/svg+xml");
    const svgTag = doc.querySelector('svg');
    const viewBox = svgTag ? svgTag.getAttribute('viewBox') : '0 0 512 512';
    const [minX, minY, vbWidth, vbHeight] = viewBox.split(' ').map(Number);
    const shapes = [
      ...Array.from(doc.querySelectorAll('path')),
      ...Array.from(doc.querySelectorAll('ellipse')),
      ...Array.from(doc.querySelectorAll('rect')),
      ...Array.from(doc.querySelectorAll('polygon'))
    ];
    svgCache[url] = { shapes, minX, minY, vbWidth, vbHeight };
  } catch (error) {
    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å SVG:', url, error);
    // –ö—ç—à–∏—Ä—É–µ–º –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —á—Ç–æ–±—ã –≤ –æ—Ç—Ä–∏—Å–æ–≤–∫–µ —Å—Ä–∞–±–æ—Ç–∞–ª fallback –Ω–∞ –∫—Ä—É–≥–∏
    svgCache[url] = { shapes: [], minX: 0, minY: 0, vbWidth: 512, vbHeight: 50 };
  }
  return svgCache[url];
}

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è drawPoints
async function drawPoints(category = "all") {
  g.selectAll("g.food-svg").remove();
  g.selectAll("circle").remove();

  const filtered = category === "all" ? data : data.filter(d => d.category === category);

  for (const d of filtered) {
    if (svgMap[d.name]) {
      let svgData = null;
      try {
        svgData = await loadSVGShapes(svgMap[d.name]);
      } catch (e) {
        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö SVG –¥–ª—è', d.name, e);
      }
if (svgData && svgData.shapes.length) {
const r = radius(d);

  // –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç, —á—Ç–æ–±—ã –∏–∑–º–µ—Ä–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
  const temp = g.append("g");
  svgData.shapes.forEach(shape => {
    const tag = shape.tagName;
    const attrs = Array.from(shape.attributes);
    const el = temp.append(tag);
    attrs.forEach(attr => el.attr(attr.name, attr.value));
  });
  const bbox = temp.node().getBBox();
  temp.remove();

// –°—á–∏—Ç–∞–µ–º –º–∞—Å—à—Ç–∞–± –ø–æ –ø–ª–æ—â–∞–¥–∏, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–≥–æ–≤–∞—Ç—ã–µ SVG –Ω–µ –≤—ã–≥–ª—è–¥–µ–ª–∏ –º–µ–Ω—å—à–µ
const bboxArea = bbox.width * bbox.height || 1; // –∑–∞—â–∏—Ç–∞ –æ—Ç –¥–µ–ª–µ–Ω–∏—è –Ω–∞ 0
const scale = Math.sqrt((Math.PI * Math.pow(r, 2)) / bboxArea); // –º–Ω–æ–∂–∏—Ç–µ–ª—å —É—Å–∏–ª–∏–≤–∞–µ—Ç —Ä–∞–∑–Ω–∏—Ü—É



  const group = g.append("g")
    .attr("class", "food-svg")
    .attr("transform", `translate(${xScale(d.sugar)},${yScale(d.fiber)}) scale(${scale}) translate(${-bbox.x - bbox.width/2},${-bbox.y - bbox.height/2})`)
    .attr("fill", getColor(d));

  svgData.shapes.forEach(shape => {
    const tag = shape.tagName;
    const attrs = Array.from(shape.attributes);
    const el = group.append(tag);
    attrs.forEach(attr => {
      if (!['fill', 'stroke', 'stroke-width', 'style'].includes(attr.name)) {
        el.attr(attr.name, attr.value);
      }
    });
    Array.from(el.node().attributes).forEach(attr => {
      if (!['d', 'cx', 'cy', 'r', 'rx', 'ry', 'points', 'x', 'y', 'width', 'height', 'transform'].includes(attr.name)) {
        el.node().removeAttribute(attr.name);
      }
    });
    el.attr('fill', getColor(d))
      .attr('stroke', 'none')
      .on("mouseover", (event) => {
        tooltip.style("opacity", 1)
          .html(`<strong>${d.name}</strong><p style="margin:6px 0 0 0;">–°–∞—Ö–∞—Ä: ${d.sugar} –≥<br>–ö–ª–µ—Ç—á–∞—Ç–∫–∞: ${d.fiber} –≥<br>–ö–∞–ª–æ—Ä–∏–∏: ${d.kcal} –∫–∫–∞–ª<br>–ë: ${d.b} –≥, –ñ: ${d.j} –≥, –£: ${d.u} –≥</p>`)
          .style("left", (event.pageX + 10) + "px")
          .style("top", (event.pageY - 40) + "px");
      })
      .on("mouseout", () => tooltip.style("opacity", 0));
  });
  continue;
}
}
    // –ï—Å–ª–∏ SVG –Ω–µ—Ç –∏–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è ‚Äî –∫—Ä—É–≥
    g.append("circle")
      .attr("class", "food")
      .attr("cx", xScale(d.sugar))
      .attr("cy", yScale(d.fiber))
      .attr("r", radius(d))
      .attr("fill", getColor(d))
      .attr('stroke', '#fff')
      .attr('stroke-width', 2)
      .on("mouseover", (event) => {
        tooltip.style("opacity", 1)
          .html(`<strong>${d.name}</strong><br>–°–∞—Ö–∞—Ä: ${d.sugar} –≥<br>–ö–ª–µ—Ç—á–∞—Ç–∫–∞: ${d.fiber} –≥<br>–ö–∞–ª–æ—Ä–∏–∏: ${d.kcal} –∫–∫–∞–ª<br>–ë–µ–ª–∫–∏: ${d.b} –≥, –ñ–∏—Ä—ã: ${d.j} –≥, –£–≥–ª–µ–≤–æ–¥—ã: ${d.u} –≥`)
          .style("left", (event.pageX + 10) + "px")
          .style("top", (event.pageY - 40) + "px");
      })
      .on("mouseout", () => tooltip.style("opacity", 0));
  }
}
// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
d3.selectAll(".filter-btn").on("click", async function() {
  const category = this.getAttribute("data-category");
  d3.selectAll(".filter-btn").classed("active", false);
  d3.select(this).classed("active", true);
  await drawPoints(category);
});

(async () => { await drawPoints(); })();
</script>

</body>
</html>





